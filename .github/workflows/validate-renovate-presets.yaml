name: Validate Renovate Presets

on:
  push:
    branches: [ 'main' ]
  pull_request:
    branches: [ 'main' ]
  workflow_dispatch:

jobs:
  validate-presets:
    name: Validate Renovate preset files
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TZ: 'Europe/Oslo'

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Validate preset files
        id: validate
        run: |
          echo "::group::ðŸšš Pulling Renovate Docker Image"
          docker pull renovate/renovate:slim
          echo "::endgroup::"
          
          echo "## ðŸ” Renovate Preset Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find all JSON files
          files=$(find . -type f \( -iname \*.json -o -iname \*.json5 \) | sort)
          file_count=$(echo "$files" | wc -l | xargs)
          
          echo "Validating $file_count Renovate preset files"
          echo "Found $file_count preset file(s) to validate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          validation_failed=0
          validated_count=0
          
          for file in $files; do
            if docker run --rm -v "${{ github.workspace }}:/github/workspace" renovate/renovate:slim \
               renovate-config-validator --strict "/github/workspace/$file"; then
              echo "| \`$file\` | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
              validated_count=$((validated_count + 1))
            else
              echo "| \`$file\` | âŒ Invalid |" >> $GITHUB_STEP_SUMMARY
              validation_failed=1
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $validation_failed -eq 0 ]; then
            echo "### âœ… All $validated_count presets are valid!" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Successfully validated $validated_count preset file(s)"
            exit 0
          else
            echo "### âŒ Validation failed for one or more presets" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
